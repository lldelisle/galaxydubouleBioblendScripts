#!/usr/bin/env python3

# Copyright 2021 Lucille Delisle
import os
import sys
import argparse
from bioblend.galaxy import GalaxyInstance


def download_datasets(gi, dataset_table, output_folder):
    if not os.path.isdir(output_folder):
        os.mkdir(output_folder)
    with open(dataset_table, 'r') as f:
        for i, line in enumerate(f, 1):
            potential_dataset = line.split()[0]
            try:
                infos = gi.datasets.show_dataset(potential_dataset)
            except Exception:
                infos = None
            if not isinstance(infos, dict):
                if i != 1 or potential_dataset != 'dataset_id':
                    print(f"Error line {i}:")
                    print(infos)
                    print("Line ignored.")
            else:
                history_name = gi.histories.show_history(infos['history_id'])['name']
                if infos['purged']:
                    print(f"Could not download {infos['name']} from {history_name} because it has been purged.")
                else:
                    history_name = gi.histories.show_history(infos['history_id'])['name']
                    current_output_folder = os.path.join(output_folder,
                                                         infos['history_id'] + "_" + history_name.replace(' ', '_'))
                    if not os.path.isdir(current_output_folder):
                        os.mkdir(current_output_folder)
                    print(f"Downloading {infos['name']} in {current_output_folder}")
                    try:
                        gi.datasets.download_dataset(potential_dataset, current_output_folder)
                    except Exception:
                        print("Could not download.")


def parse_arguments(args=None):
    argp = argparse.ArgumentParser(
        description=("Download datasets from dataset ids."))
    argp.add_argument('--url', default='galaxyduboule.epfl.ch',
                      help="A FQDN or IP for a given instance of Galaxy.")
    argp.add_argument('--api', default=None, required=True,
                      help="Your API key. Can be obtained from the webpage."
                      " User - Settings - Manage API key")
    argp.add_argument('--datasetTable', default=None, required=True,
                      help="Input table with one line per dataset."
                      " It should correspond to the History Content API ID."
                      " It can also be generated by get_datasets.py")
    argp.add_argument('--outputFolder', default=None, required=True,
                      help="Folder where files will be downloaded.")
    return(argp)


def main(args=None):
    args = parse_arguments().parse_args(args)
    gi = GalaxyInstance(args.url, key=args.api)
    download_datasets(gi, args.datasetTable, args.outputFolder)


if __name__ == "__main__":
    args = None
    if len(sys.argv) == 1:
        args = ["--help"]
    main(args)
